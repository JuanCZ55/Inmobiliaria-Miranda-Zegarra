@model IEnumerable<Inmobiliaria.Models.TipoInmueble>
@{
  ViewData["Title"] = "Listado de Tipos de Inmueble";
  Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Listado de Tipos de Inmueble <a class="btn btn-primary " asp-controller="TipoInmueble" asp-action="Crear">+</a>
</h2>

<div class="container px-0 p-3">
  <div class="d-flex">
    <div class="zeg-field" style="max-width: 300px;">
      <input type="text" id="nombreInput" name="nombre" class="zeg-input" placeholder=" " />
      <label for="nombreInput">Ingrese nombre</label>
    </div>
  </div>
</div>


<table class="table table-hover table-caption-top">
  <thead class="table-dark">
    <tr>
      <th>IdTipoInmueble</th>
      <th>Nombre</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tablaTipo">
    <!-- Se llenara dinamicamente -->
  </tbody>
</table>

<div class="d-flex justify-content-between align-items-center">
  <button type="button" onclick="cambiarPagina(-1)">&lt;</button>
  <select id="paginas"></select>
  <button type="button" onclick="cambiarPagina(1)">&gt;</button>
</div>

@if (TempData["Mensaje"] != null)
{
  <div class="alert alert-success alertaTemp">@TempData["Mensaje"]</div>
}
@if (TempData["Warning"] != null)
{
  <div class="alert alert-warning alertaTemp">@TempData["Warning"]</div>
}

<script>
  let paginaActual = 1;

  async function ListarNombre() {
    const input = document.getElementById("nombreInput").value.trim();
    try {
      let url = input
        ? `/TipoInmueble/ListarPorNombre?nombre=${encodeURIComponent(input)}&PaginaActual=${paginaActual}`
        : `/TipoInmueble/ListarTodos?PaginaActual=${paginaActual}`;

      const response = await fetch(url);
      if (!response.ok) throw new Error("Error en la busqueda");

      const data = await response.json();
      const tbody = document.getElementById("tablaTipo");
      tbody.innerHTML = "";

      if (!data.lista || data.lista.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center">No se encontraron tipos de inmueble</td></tr>`;
        document.getElementById("paginas").innerHTML = "";
        return;
      }

      data.lista.forEach(t => {
        tbody.innerHTML += `
                    <tr>
                        <td>${t.idTipoInmueble}</td>
                        <td>${t.nombre}</td>
                        <td class="d-flex justify-content-evenly">
                            <a href="/TipoInmueble/Modificar/${t.idTipoInmueble}" class="btn btn-warning btn-sm">Modificar</a>
                            <form action="/TipoInmueble/Eliminar/${t.idTipoInmueble}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                        </td>
                    </tr>`;
      });

      // Actualizamos el select de paginas
      const select = document.getElementById("paginas");
      select.innerHTML = "";
      for (let i = 1; i <= data.totalPaginas; i++) {
        select.innerHTML += `<option value="${i}" ${i === paginaActual ? "selected" : ""}>${i}</option>`;
      }

    } catch (err) {
      console.error(err);
      alert("Hubo un problema al buscar");
    }
  }

  function cambiarPagina(valor) {
    const select = document.getElementById("paginas");
    let nuevaPagina = paginaActual + valor;
    const maxPagina = select.options.length;
    if (nuevaPagina < 1) nuevaPagina = 1;
    if (nuevaPagina > maxPagina) nuevaPagina = maxPagina;
    paginaActual = nuevaPagina;
    ListarNombre();
  }

  document.getElementById("paginas").addEventListener("change", function () {
    paginaActual = parseInt(this.value);
    ListarNombre();
  });

  document.getElementById("nombreInput").addEventListener("input", function () {
    paginaActual = 1;
    ListarNombre();
  });

  window.onload = ListarNombre;
</script>
